import time

import dash
import dash_bootstrap_components as dbc
from dash import dcc, html, callback
from dash.dependencies import Input, Output, State
from loguru import logger

from src.utils import models
from src.utils.graphing import single_defect
from src.utils.layout import generate_input_section, generate_input

dash.register_page(__name__)


def layout():
    pipe_dimensions = dbc.Col(
        generate_input_section(
            section_name='Pipe Dimensions',
            input_fields=[('Outer Diameter', 'number', 'mm'), ('Wall Thickness', 'number', 'mm')]),
        style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top'})

    material_properties = dbc.Col(
        generate_input_section(
            section_name='Material Properties',
            input_fields=[('SMTS', 'number', 'MPa'), ('SMYS', 'number', 'MPa')]),
        style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top'})

    defect_properties = dbc.Col(
        generate_input_section(
            section_name='Defect Properties',
            input_fields=[('Defect Length', 'number', 'mm'), ('Defect Depth', 'number', '%/mm'), ('Defect Elevation', 'number', 'm')]),
        style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top'})

    environment_properties = dbc.Col(
        generate_input_section(
            section_name='Environment Properties',
            input_fields=[('Seawater Density', 'number', 'kg/m³'), ('Containment Density', 'number', 'kg/m³'), ('Elevation Reference', 'number', 'm')]),
        style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top'})

    design_parameters = dbc.Col([
        html.H4("Design Parameters"),
        dbc.Form([
            dbc.Row([dbc.Col(generate_input('Design Pressure', 'number'))]),
            dbc.Row([dbc.Col(generate_input('Design Temperature', 'number'))]),
            dbc.Row([dbc.Col(generate_input('Incidental to Design Pressure Ratio', 'number'))]),
            dbc.Row([dbc.Col(dcc.Dropdown(id='safety_class', options=[
                'low', 'medium', 'high'], placeholder='Safety Class'))
                     ], style={'padding': '10px 0px'})
        ])
    ], style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top', 'width': 250})

    measurement_parameters = dbc.Col([
        html.H4("Measurement Parameters"),
        dbc.Form([
            dbc.Row([dbc.Col(generate_input('Accuracy', 'number'))]),
            dbc.Row([dbc.Col(generate_input('Confidence Level', 'number'))]),
            dbc.Row([dbc.Col(dcc.Dropdown(id='measurement_method', options=[
                'relative', 'absolute'], placeholder='Measurement Method'))
                     ], style={'padding': '10px 0px'})
        ])
    ], style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top'})

    loading_parameters = dbc.Col([
        html.H4("Loading Parameters"),
        dbc.Form([
            dbc.Row([dbc.Col(generate_input('Axial Load', 'number'))]),
            dbc.Row([dbc.Col(generate_input('Bending Load', 'number'))]),
            dbc.Row([dbc.Col(generate_input('Combined Load', 'number'))])
        ])
    ], style={'display': 'inline-block', 'padding': '0px 10px', 'vertical-align': 'text-top'})

    graphs = dbc.Row([
            dbc.Col(dcc.Loading(
                dcc.Graph(id='single_defect_graph', figure={}, style={'display': 'inline-block', 'width': '70vw'}))),
            dbc.Col(dcc.Loading(
                dcc.Graph(id='single_defect_pipe_graph', figure={}, style={'display': 'inline-block', 'width': '15vw'}))
            )
        ]
    )

    center_align_style = {
            "text-align": "center",
            "display": "flex",
            "justify-content": "center",
            "align-items": "top"
        }

    input_layout = dbc.Row(
        children=[
            dbc.Row([
                dbc.Col(pipe_dimensions, width=3),
                dbc.Col(material_properties, width=3)
            ], style=center_align_style),
            dbc.Row([
                dbc.Col(defect_properties, width=3),
                dbc.Col(environment_properties, width=3)
            ], style=center_align_style),
            dbc.Row([
                dbc.Col(design_parameters, width=3),
                dbc.Col(measurement_parameters, width=3)
            ], style=center_align_style),
            dbc.Row([
                dbc.Col(loading_parameters, width=3),
                dbc.Col([
                    dbc.Row(html.Button(children='Refresh', id='single_defect_analyse')),
                    dbc.Row(html.Div(
                        id='single_defect_analysis',
                        style={'display': 'inline-block', "padding": "0px 10px", "vertical-align": "middle"}))
                ], width=3)
            ], style=center_align_style),
        ],
        justify='center',
    )

    combined_layout = html.Div(
        [
            dbc.Row(html.H1("Single Defect Analysis"), style={"text-align": "center"}),
            input_layout,
            html.H3('Remaining Life Assessment'),
            html.Div(graphs),
            html.Div(id='single_defect_evaluation')
        ],
        style={"padding": "10px 10px"}
    )

    return combined_layout


def example_a_1():
    pipe_config = {
        'outside_diameter': 812.8,
        'wall_thickness': 19.1,
        'alpha_u': 0.96,
        'smts': 530.9,
        'design_pressure': 150,
        'design_temperature': 75,
        'incidental_to_design_pressure_ratio': 1.1,
        'accuracy': 0.1,
        'confidence_level': 0.8,
        'safety_class': 'medium',
        'measurement_method': 'relative'
    }

    defect_config = {
        'length': 200,
        'elevation': -100,
        'relative_depth': 0.25
    }

    environment_config = {
        'seawater_density': 1025,
        'containment_density': 200,
        'elevation_reference': 30
    }

    pipe = init_pipe(pipe_config, defect_config, environment_config)

    return pipe


def init_pipe(pipe_config, defect_config, environment_config):
    pipe = models.Pipe(config=pipe_config)
    defect = models.Defect(**defect_config)
    environment = models.Environment(**environment_config)

    pipe.add_defect(defect)
    pipe.set_environment(environment)

    # Calculate length correction factor
    defect.generate_length_correction_factor(
        d_nominal=pipe.dimensions.outside_diameter,
        t=pipe.dimensions.wall_thickness
    )

    # Calculate p_corr
    pipe.calculate_pressure_resistance()
    pipe.calculate_effective_pressure()
    return pipe


# Add controls to build the interaction
@callback(
    Output(component_id='single_defect_graph', component_property='figure'),
    Output(component_id='single_defect_pipe_graph', component_property='figure'),
    Output(component_id='single_defect_analysis', component_property='children'),
    Output(component_id='single_defect_evaluation', component_property='children'),
    Input(component_id='single_defect_analyse', component_property='n_clicks'),
    State(component_id='input_outer_diameter', component_property='value'),
    State(component_id='input_wall_thickness', component_property='value'),
    State(component_id='input_smts', component_property='value'),
    State(component_id='input_design_pressure', component_property='value'),
    State(component_id='input_design_temperature', component_property='value'),
    State(component_id='input_incidental_to_design_pressure_ratio', component_property='value'),
    State(component_id='input_accuracy', component_property='value'),
    State(component_id='input_confidence_level', component_property='value'),
    State(component_id='safety_class', component_property='value'),
    State(component_id='measurement_method', component_property='value'),
    State(component_id='input_defect_length', component_property='value'),
    State(component_id='input_defect_depth', component_property='value'),
    State(component_id='input_defect_elevation', component_property='value'),
    State(component_id='input_seawater_density', component_property='value'),
    State(component_id='input_containment_density', component_property='value'),
    State(component_id='input_elevation_reference', component_property='value')
)
def update_graph(trigger_update,
                 pipe_outer_diameter,
                 pipe_wall_thickness,
                 smts,
                 design_pressure,
                 design_temperature,
                 incidental_to_design_pressure_ratio,
                 accuracy,
                 confidence_level,
                 safety_class,
                 measurement_method,
                 defect_length,
                 defect_depth,
                 defect_elevation,
                 seawater_density,
                 containment_density,
                 elevation_reference):
    start_time = time.time()
    if not trigger_update:
        pipe = example_a_1()
    elif trigger_update > 0:
        pipe_config = {
            'outside_diameter': pipe_outer_diameter,
            'wall_thickness': pipe_wall_thickness,
            'alpha_u': 0.96,
            'smts': smts,
            'design_pressure': design_pressure,
            'design_temperature': design_temperature,
            'incidental_to_design_pressure_ratio': incidental_to_design_pressure_ratio,
            'accuracy': accuracy,
            'confidence_level': confidence_level,
            'safety_class': safety_class,
            'measurement_method': measurement_method
        }

        defect_config = {
            'length': defect_length,
            'relative_depth': defect_depth,
            'elevation': defect_elevation
        }

        environment_config = {
            'seawater_density': seawater_density,
            'containment_density': containment_density,
            'elevation_reference': elevation_reference
        }

        pipe = init_pipe(pipe_config, defect_config, environment_config)

    fig1 = single_defect.generate_defect_depth_plot(pipe)
    fig2 = single_defect.generate_cross_section_plot(pipe)
    analysis = [
        f"""Effective Pressure:         {pipe.properties.effective_pressure:.2f}
        Pressure Resistance:        {pipe.properties.pressure_resistance:.2f}
        """
    ]
    evaluation = f"Effective Pressure {pipe.properties.effective_pressure:.2f} MPa " \
                 f"{'<' if pipe.properties.effective_pressure < pipe.properties.pressure_resistance else '>'} " \
                 f"Pressure Resistance {pipe.properties.pressure_resistance:.2f} MPa. " \
                 f"Corrosion is {'acceptable' if pipe.properties.effective_pressure < pipe.properties.pressure_resistance else 'unacceptable'}."
    analysis = [html.Div(contents, style={
        'whiteSpace': 'pre-line', 'display': 'inline-block', "padding": "0px 10px", "vertical-align": "text-top"})
                for contents in analysis]
    logger.debug(f"Single-Defect Scenario loaded | Render time: {time.time() - start_time:.2f}s")
    return fig1, fig2, analysis, evaluation
